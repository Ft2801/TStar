# =============================================================================
# TStar macOS Build Workflow
# =============================================================================
# Automatically builds TStar for macOS using GitHub's macOS runners.
# This allows building macOS binaries from Windows by pushing to GitHub.
#
# How to use:
#   1. Push this file to your GitHub repository
#   2. Go to the "Actions" tab in your repository
#   3. The build will start automatically
#   4. Download the DMG from the "Artifacts" section when complete
# =============================================================================

name: macOS Build

on:
  push:
    branches: [ main, master, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  build-macos:
    name: Build macOS App
    runs-on: macos-14  # Apple Silicon runner (faster)
    
    env:
      QT_VERSION: "6.6.2"
    
    steps:
      # ===========================
      # 1. Checkout Repository
      # ===========================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version detection

      # ===========================
      # 2. Cache Homebrew packages
      # ===========================
      - name: Cache Homebrew packages
        uses: actions/cache@v4
        id: cache-brew
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar
          key: ${{ runner.os }}-brew-${{ hashFiles('**/CMakeLists_macos.txt') }}
          restore-keys: |
            ${{ runner.os }}-brew-

      # ===========================
      # 3. Install System Dependencies (Homebrew)
      # ===========================
      - name: Install Dependencies via Homebrew
        run: |
          echo ">>> Installing build tools..."
          brew install cmake ninja pkg-config
          brew link --overwrite cmake ninja pkg-config || true
          
          echo ">>> Installing Qt6..."
          brew install qt
          brew link --overwrite qt || true
          
          echo ">>> Installing image/scientific libraries..."
          brew install opencv
          brew link --overwrite opencv || true
          brew install gsl
          brew link --overwrite gsl || true
          brew install cfitsio
          brew link --overwrite cfitsio || true
          
          echo ">>> Installing compression libraries..."
          brew install lz4
          brew link --overwrite lz4 || true
          brew install zstd
          brew link --overwrite zstd || true
          
          echo ">>> Installing OpenMP..."
          brew install libomp
          brew link --overwrite libomp || true
          
          echo ">>> Installing DMG creation tool..."
          brew install create-dmg
          brew link --overwrite create-dmg || true
          
          echo ">>> Installing Python..."
          brew install python@3.11
          brew link --overwrite python@3.11 || true
          
          echo ">>> All dependencies installed!"

      # ===========================
      # 4. Setup Python Environment
      # ===========================
      - name: Setup Python Virtual Environment
        run: |
          chmod +x setup_python_macos.sh
          ./setup_python_macos.sh

      # ===========================
      # 5. Configure CMake
      # ===========================
      # ===========================
      # 5. Configure CMake
      # ===========================
      - name: Configure CMake
        run: |
          # Definitive Qt6 Detection for Homebrew
          echo ">>> Detecting Qt6 paths..."
          
          # Initialize variables
          QT_PREFIXES=""
          QT6_DIR_DETECTED=""
          
          # 1. Get the primary prefix from brew
          PRIMARY_QT_PREFIX=$(brew --prefix qt 2>/dev/null || brew --prefix qt@6 2>/dev/null)
          
          if [ -n "$PRIMARY_QT_PREFIX" ]; then
            echo "âœ… Found primary Qt prefix at: $PRIMARY_QT_PREFIX"
            
            # 2. Try qmake or qmake6
            QMAKE_BIN=""
            if [ -x "$PRIMARY_QT_PREFIX/bin/qmake6" ]; then
                QMAKE_BIN="$PRIMARY_QT_PREFIX/bin/qmake6"
            elif [ -x "$PRIMARY_QT_PREFIX/bin/qmake" ]; then
                QMAKE_BIN="$PRIMARY_QT_PREFIX/bin/qmake"
            fi
            
            if [ -n "$QMAKE_BIN" ]; then
              QT_INSTALL_LIBS=$("$QMAKE_BIN" -query QT_INSTALL_LIBS | tr -d '\r\n')
              echo "â„¹ï¸  qmake reports libs at: $QT_INSTALL_LIBS"
              
              # Standard location in Homebrew: $QT_INSTALL_LIBS/cmake/Qt6
              CANDIDATE="$QT_INSTALL_LIBS/cmake/Qt6"
              if [ -d "$CANDIDATE" ]; then
                # List contents to confirm existence of config files
                echo ">>> Listing contents of $CANDIDATE:"
                ls -la "$CANDIDATE"
                
                QT6_DIR_DETECTED="$CANDIDATE"
                echo "âœ… Verified Qt6 CMake dir via qmake: $QT6_DIR_DETECTED"
              fi
            else
               echo "âš ï¸  Could not find executable qmake or qmake6 in $PRIMARY_QT_PREFIX/bin"
            fi
          fi
          
          # 3. Fallback: Aggregate prefixes & Try direct "Force" detection
          for pkg in qt qt@6 qtbase qtsvg qttools; do
            PKG_PATH=$(brew --prefix $pkg 2>/dev/null)
            if [ -n "$PKG_PATH" ]; then
              echo "â„¹ï¸  Found $pkg: $PKG_PATH"
              if [ -z "$QT_PREFIXES" ]; then QT_PREFIXES="$PKG_PATH"; else QT_PREFIXES="$QT_PREFIXES;$PKG_PATH"; fi
              
              # If qmake failed, try to guess the path
              if [ -z "$QT6_DIR_DETECTED" ]; then
                 if [ -d "$PKG_PATH/lib/cmake/Qt6" ]; then
                    echo ">>> Found directory $PKG_PATH/lib/cmake/Qt6 (Optimistic Fallback)"
                    echo ">>> Contents:"
                    ls -la "$PKG_PATH/lib/cmake/Qt6"
                    QT6_DIR_DETECTED="$PKG_PATH/lib/cmake/Qt6"
                 fi
              fi
            fi
          done
          
          # 4. Final Failsafe Diagnostic
          if [ -z "$QT6_DIR_DETECTED" ]; then
             echo "âš ï¸  CRITICAL: Could not find any lib/cmake/Qt6 directory!"
          fi
          
          # Export for use in next commands
          export CMAKE_PREFIX_PATH="$QT_PREFIXES"
          export Qt6_DIR="$QT6_DIR_DETECTED"
          
          echo ">>> Final CMAKE_PREFIX_PATH: $CMAKE_PREFIX_PATH"
          echo ">>> Final Qt6_DIR: $Qt6_DIR"
          
          # Get libomp path for OpenMP support with Apple Clang
          LIBOMP_PREFIX=$(brew --prefix libomp)
          echo "libomp found at: $LIBOMP_PREFIX"
          
          # Use the macOS-specific CMakeLists
          cp CMakeLists_macos.txt CMakeLists.txt
          
          # Configure with CMake (Surgical pass of Qt6_DIR)
          CMAKE_EXTRA_ARGS=""
          if [ -n "$Qt6_DIR" ]; then
            CMAKE_EXTRA_ARGS="-DQt6_DIR=$Qt6_DIR"
          fi
          
          cmake -S . -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH" \
            $CMAKE_EXTRA_ARGS \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="11.0" \
            -DOpenMP_C_FLAGS="-Xpreprocessor -fopenmp -I${LIBOMP_PREFIX}/include" \
            -DOpenMP_CXX_FLAGS="-Xpreprocessor -fopenmp -I${LIBOMP_PREFIX}/include" \
            -DOpenMP_C_LIB_NAMES="omp" \
            -DOpenMP_CXX_LIB_NAMES="omp" \
            -DOpenMP_omp_LIBRARY="${LIBOMP_PREFIX}/lib/libomp.dylib"

      # ===========================
      # 6. Build Application
      # ===========================
      - name: Build TStar
        run: |
          cmake --build build --config Release --parallel $(sysctl -n hw.ncpu)

      # ===========================
      # 7. Verify Build
      # ===========================
      - name: Verify Build Output
        run: |
          if [ -d "build/TStar.app" ]; then
            echo "âœ… TStar.app bundle created successfully"
            ls -la build/TStar.app/Contents/MacOS/
          elif [ -f "build/TStar" ]; then
            echo "âœ… TStar binary created (non-bundle)"
          else
            echo "âŒ Build output not found!"
            exit 1
          fi

      # ===========================
      # 8. Package Distribution
      # ===========================
      - name: Package App Bundle
        run: |
          chmod +x src/package_macos.sh
          ./src/package_macos.sh --silent

      # ===========================
      # 9. Create DMG Installer
      # ===========================
      - name: Create DMG Installer
        run: |
          chmod +x src/build_installer_macos.sh
          ./src/build_installer_macos.sh

      # ===========================
      # 10. Upload DMG Artifact
      # ===========================
      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TStar-macOS-Installer
          path: installer_output/*.dmg
          if-no-files-found: error
          retention-days: 30

      # ===========================
      # 11. Upload App Bundle (alternative)
      # ===========================
      - name: Upload App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: TStar-macOS-App
          path: dist/TStar.app
          if-no-files-found: warn
          retention-days: 30

      # ===========================
      # 12. Build Summary
      # ===========================
      - name: Build Summary
        run: |
          echo "## macOS Build Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get version
          VERSION=$(grep -E "^Version [0-9.]+" changelog.txt | head -1 | awk '{print $2}')
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List artifacts
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **DMG Installer:** \`installer_output/TStar_Setup_${VERSION}.dmg\`" >> $GITHUB_STEP_SUMMARY
          echo "- **App Bundle:** \`dist/TStar.app\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Notes
          echo "### Notes" >> $GITHUB_STEP_SUMMARY
          echo "- Built on macOS runner with Apple Silicon" >> $GITHUB_STEP_SUMMARY
          echo "- Compatible with macOS 11.0 (Big Sur) and later" >> $GITHUB_STEP_SUMMARY
          echo "- First launch: Right-click â†’ Open to bypass Gatekeeper" >> $GITHUB_STEP_SUMMARY
